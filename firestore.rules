rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the requesting user is the owner of a document.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper function to check if the user has an admin custom claim.
    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    /**
     * @description Secures user profile documents.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // Anyone can read user profiles.
      allow read;

      // Users can create their own profile.
      allow create: if isOwner(userId);

      // Users can update their own profile, but cannot change admin-only fields.
      // Admins can update any field.
      allow update: if (isOwner(userId) && !(
                      'rosterStatus' in request.resource.data && request.resource.data.rosterStatus != resource.data.rosterStatus
                    ) && !(
                      'playstyleTags' in request.resource.data && request.resource.data.playstyleTags != resource.data.playstyleTags
                    )) || isAdmin();

      // Only admins can delete user profiles.
      allow delete: if isAdmin();
    }

    /**
     * @description Secures user votes.
     * @path /votes/{voteId}
     */
    match /votes/{voteId} {
      // Any authenticated user can read all votes.
      allow read: if isSignedIn();

      // Users can create, update, and delete their own votes.
      // An admin can also delete any vote.
      allow write: if (isSignedIn() && request.resource.data.userId == request.auth.uid) || (isAdmin() && request.method == 'delete');
    }

    /**
     * @description Manages scheduled events.
     * @path /scheduledEvents/{eventId}
     */
    match /scheduledEvents/{eventId} {
      // Any authenticated user can read events.
      allow read: if isSignedIn();

      // Any authenticated user can create events.
      allow create: if isSignedIn();

      // Only the event creator or an admin can update or delete an event.
      allow update, delete: if isSignedIn() && (isOwner(resource.data.creatorId) || isAdmin());
    }
  }
}
